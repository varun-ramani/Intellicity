<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>IntelliCity</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
    <style>
        /* Always set the map height explicitly to define the size of the div
             * element that contains the map. */
        #map {
            height: 100%;
        }

        /* Optional: Makes the sample page fill the window. */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
</head>

<body>

    <div class="modal" id="auth" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header justify-content-center">
                    <h5 class="modal-title">Authentication</h5>

                </div>
                <div class="modal-body">
                    <div id="authmsg"></div>

                    <div class="container">
                        <div class="row my-2">
                            <input type="email" class="col s12 form-control" id="email" placeholder="Email">
                        </div>
                        <div class="row my-2">
                            <input type="password" class="col s12 form-control" id="password" placeholder="Password">
                        </div>
                        <div class="row my-2">
                            <button type="button" onclick="login()" id="login" class="btn btn-primary col s6 mx-2">
                                Login
                            </button>
                            <button type="button" id="register" onclick="register()"
                                class="btn btn-primary col s6 mx-2">
                                Register
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container " style="z-index: 4; position: fixed;   left: 50%; transform: translate(-50%, 0); bottom:5%">
        <br>
        <button type="button" class="btn btn-danger btn-block" data-toggle="modal" data-target="#reportmodal">
            Report Now
        </button>
    </div>
    <div class="modal" tabindex="-1" id="reportmodal" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Report!</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="" data-toggle="buttons">
                        <div class="container row">
                            <div class="col s4" style="text-align: center">
                                <button class="a1 btn-lg btn-danger" style="outline: none !important;"
                                    data-toggle="collapse" href="#hazards"><i
                                        class="fas fa-exclamation-circle"></i></button>
                            </div>
                            <div class="col s4" style="text-align: center">

                                <button class="a1 btn-lg btn-dark" style="outline: none !important;"
                                    data-toggle="collapse" href="#crimes"><i
                                        class="fas fa-skull-crossbones"></i></button>
                            </div>
                            <div class="col s4" style="text-align: center">

                                <button class="a1 btn-lg btn-success" style="outline: none !important;"
                                    data-toggle="collapse" href="#utilities"><i class="fa fa-toilet"></i></button>
                            </div>
                        </div>
                    </div>
                    <br>

                    <!-- HAZARDS COLLAPSE -->
                    <div class="a2 card collapse py-4" id="hazards" style="border-radius: 15px; ">
                        <div class="card-content">
                            <div class="" data-toggle="buttons2">
                                <div class="container row">
                                    <div class="col s4" style="text-align: center">
                                        <button class="btn-lg "
                                            style=" outline: none !important; background-color: orange"
                                            data-toggle="collapse" href="#final"><i class="fas fa-fire-alt"
                                                onclick="updateTag('Fire')"></i></button>
                                    </div>
                                    <div class="col s4" style="text-align: center">
                                        <button class="btn-lg btn-primary" style=" outline: none !important;"
                                            data-toggle="collapse" href="#final" onclick="updateTag('Flooding')"><i
                                                class="fas fa-water"></i></button>
                                    </div>
                                    <div class="col s4" style="text-align: center">
                                        <button class="btn-lg btn-dark" style="outline: none !important;"
                                            data-toggle="collapse" href="#final"
                                            onclick="updateTag('Infrastructure Damage')"><i
                                                class="fas fa-hammer"></i></button>
                                    </div>
                                    <div class="col s4" style="text-align: center">
                                        <button class="btn-lg btn-warning" style="outline: none !important;"
                                            data-toggle="collapse" href="#final"
                                            onclick="updateTag('Electrical Damage')"><i
                                                class="fas fa-bolt"></i></button>
                                    </div>
                                    <div class="col s4" style="text-align: center">
                                        <button class="btn-lg btn-danger" style="outline: none !important;"
                                            data-toggle="collapse" href="#final" onclick="updateTag('Car Crash')"><i
                                                class="fas fa-car-crash"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- CRIMES COLLAPSE -->
                    <div class="a2 card collapse py-4" id="crimes" style="border-radius: 15px; ">
                        <div class="card-content">
                            <div class="" data-toggle="buttons2">
                                <div class="container row">
                                    <div class="col s4" style="text-align: center">
                                        <button class="btn-lg btn-danger" style="outline: none !important;"
                                            data-toggle="collapse" href="#final" onclick="updateTag('Violent Crime')"><i
                                                class="fas fa-dizzy"></i></button>
                                    </div>
                                    <div class="col s4" style="text-align: center">
                                        <button class="btn-lg btn-dark" style="outline: none !important;"
                                            data-toggle="collapse" href="#final"
                                            onclick="updateTag('Nonviolent Crime')"><i class="fas fa-user"></i></button>
                                    </div>

                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- UTILITIES COLLAPSE -->
                    <div class="a2 card collapse py-4" id="utilities" style="border-radius: 15px; ">
                        <div class="card-content">
                            <div class="" data-toggle="buttons2">
                                <div class="container row">
                                    <div class="col s4" style="text-align: center">
                                        <button class="btn-lg btn-primary" style="outline: none !important;"
                                            data-toggle="collapse" href="#final" onclick="updateTag('Restroom')"><i
                                                class="fas fa-restroom"></i></button>
                                    </div>
                                    <div class="col s4" style="text-align: center">
                                        <button class="btn-lg btn-dark" style=" outline: none !important;"
                                            data-toggle="collapse" href="#final" onclick="updateTag('Parking')"><i
                                                class="fas fa-parking"></i></button>
                                    </div>
                                    <div class="col s4" style="text-align: center">
                                        <button class="btn-lg btn-success" style="outline: none !important;"
                                            data-toggle="collapse" href="#final" onclick="updateTag('Trash')"><i
                                                class="fa fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="collapse" id="final">
                        <br>
                        <input class="form-control mb-3" id="tag" type="text" value="" disabled>
                        <div class="form-group">
                            <textarea class="form-control" placeholder="Description" id="description"
                                rows="1"></textarea>
                        </div>
                        <div class="input-group mb-3">
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="cameraInput" accept="image/*"
                                    capture="environment" onchange="previewFile()">
                                <label class="custom-file-label" for="inputGroupFile01">Choose Image</label>
                            </div>
                        </div>

                        <button class="btn btn-block btn-primary" onclick="report()"
                            data-dismiss="modal">Submit</button>
                    </div>
                </div>

            </div>
        </div>
    </div>



    <div id="map" style="z-index:1; position: relative;"></div>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>

    <script>
        if (Cookies.get('authtoken') == null) {
            $('#auth').modal({ backdrop: 'static', keyboard: false })
        }

        function login() {
            email = document.getElementById('email').value
            password = document.getElementById('password').value
            console.log(email + " " + password)
            if (email == '' || password == '') {
                document.getElementById('authmsg').innerHTML = "<div class='alert alert-danger' id='authmsg' role='alert'>Bad Credentials</div>"
                return
            }
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    tmp = JSON.parse(xhr.responseText)
                    if (tmp['status'] == 'success') {
                        $('#auth').modal('hide')
                        Cookies.set('authtoken', tmp['authtoken'])
                    } else {
                        document.getElementById('authmsg').innerHTML = "<div class='alert alert-danger' id='authmsg' role='alert'>Bad Credentials</div>"
                        return
                    }
                } else {
                    document.getElementById('authmsg').innerHTML = "<div class='alert alert-danger' id='authmsg' role='alert'>Error</div>"
                    return
                }
            };
            xhr.open("POST", "https://safetynet.abobba.com/api/login", true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                "email": email,
                "password": password
            }));

        }

        function register() {
            email = document.getElementById('email').value
            password = document.getElementById('password').value
            console.log(email + " " + password)
            if (email == '' || password == '') {
                document.getElementById('authmsg').innerHTML = "<div class='alert alert-danger' id='authmsg' role='alert'>Bad Input</div>"
                return
            }
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    tmp = JSON.parse(xhr.responseText)
                    if (tmp['status'] == 'success') {
                        $('#auth').modal('hide')
                        Cookies.set('authtoken', tmp['authtoken'])
                    } else {
                        document.getElementById('authmsg').innerHTML = "<div class='alert alert-danger' id='authmsg' role='alert'>Email already in use!</div>"
                        return
                    }
                } else {
                    document.getElementById('authmsg').innerHTML = "<div class='alert alert-danger' id='authmsg' role='alert'>Error</div>"
                    return
                }
            };
            xhr.open("POST", "https://safetynet.abobba.com/api/register", true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                "email": email,
                "password": password
            }));
        }


    </script>
    <script>
        const socket = io('https://intellicity.tech');
        // const socket = io('http://127.0.0.1:5000');

        socket.on('message', (data) => {
            currPos()
            console.log('socket receive')
        });
        var map, infoWindow, tmp, pos2;
        var heatmapData = []

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                // center: { lat: -34.397, lng: 150.644 },
                zoom: 16
            });
            currPos()
        }
        function currPos() {
            markers = []
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function () {
                        if (this.readyState == 4 && this.status == 200) {
                            tmp = JSON.parse(xhr.responseText)
                            console.log(tmp)
                            tmp.forEach(function (a) {
                                marker = new google.maps.Marker({
                                    map: map,
                                    draggable: false,
                                    animation: google.maps.Animation.DROP,
                                    position: { lat: a['latitude'], lng: a['longitude'] }
                                })
                                data = {
                                    'marker': marker,
                                    'id': a['_id'],
                                    'description': a['description'],
                                    'tag': a['tags']
                                }
                                markers.push(data)
                                marker.addListener('click', function () {


                                    var xhr = new XMLHttpRequest();
                                    xhr.onreadystatechange = function () {
                                        if (this.readyState == 4 && this.status == 200) {
                                            tmp = JSON.parse(xhr.responseText)
                                            img = "data:image/png;base64," + tmp['image']

                                        }else{
                                            img = ""
                                        }

                                        contentString = "<div class=\"card\" style=\"width: 18rem;\">\r\n  <img class=\"card-img-top\" src=\"" + img + "\" alt=\"Image Not Available\">\r\n  <div class=\"card-body\">\r\n    <h5 class=\"card-title\">" + data['tag'] + "</h5>\r\n    <p class=\"card-text\">" + data['description'] + "</p>\r\n  </div>\r\n</div>"
                                        var infowindow = new google.maps.InfoWindow({
                                            content: contentString
                                        });
                                        infowindow.open(map, marker);
                                    };
                                    xhr.open("POST", "https://safetynet.abobba.com/api/retrieveimg", true);
                                    xhr.setRequestHeader('Content-Type', 'application/json');
                                    xhr.send(JSON.stringify({
                                        // "id": data['id']['$oid']
                                        "id": data['id']
                                    }));




                                });

                                heatmapData.push(new google.maps.LatLng(a['latitude'], a['longitude']))
                            });
                            console.log(markers)

                            var heatmap = new google.maps.visualization.HeatmapLayer({
                                data: heatmapData
                            });
                            heatmap.setOptions({ "radius": 15 })
                            heatmap.setMap(map);
                        }
                    };
                    xhr.open("POST", "https://safetynet.abobba.com/api/retrieve", true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send(JSON.stringify({
                        "longitude": position.coords.longitude,
                        "latitude": position.coords.latitude
                    }));
                    pos2 = {
                        'lat': position.coords.latitude,
                        'lng': position.coords.longitude
                    }
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(pos);
                }, function () {
                    handleLocationError(true, infoWindow, map.getCenter());
                });
            } else {
                handleLocationError(false, infoWindow, map.getCenter());
            }
            console.log(heatmapData)
        }

        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            infoWindow.setPosition(pos);
            infoWindow.setContent(browserHasGeolocation ?
                'Error: The Geolocation service failed.' :
                'Error: Your browser doesn\'t support geolocation.');
            infoWindow.open(map);
        }


        tag = ''
        imagefinal = ''
        function previewFile() {
            // Read in file
            var file = event.target.files[0];

            // Ensure it's an image
            if (file.type.match(/image.*/)) {
                console.log('An image has been loaded');

                // Load the image
                var reader = new FileReader();
                reader.onload = function (readerEvent) {
                    var image = new Image();
                    image.onload = function (imageEvent) {

                        // Resize the image

                        var canvas = document.createElement('canvas'),
                            max_size = 150,// TODO : pull max size from a site config
                            width = image.width
                        height = image.height
                        if (width > height) {
                            if (width > max_size) {
                                height *= max_size / width;
                                width = max_size;
                            }
                        } else {
                            if (height > max_size) {
                                width *= max_size / height;
                                height = max_size;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        canvas.getContext('2d').drawImage(image, 0, 0, width, height);
                        var dataUrl = canvas.toDataURL('image/jpeg');
                        imagefinal = dataUrl
                        console.log(dataUrl)

                    }
                    image.src = readerEvent.target.result;

                }
                reader.readAsDataURL(file);
            }
        };



        function updateTag(tag2) {
            tag = tag2
            console.log("a" + tag2)
            document.getElementById('tag').value = tag
        }
        function report() {
            currPos()
            data = {
                'tags': tag,
                'longitude': pos2['lng'],
                'latitude': pos2['lat'],
                'authtoken': Cookies.get('authtoken'),
                'image': imagefinal,
                'description': document.getElementById('description').value

            }
            console.log(data)
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    tmp = JSON.parse(xhr.responseText)
                    if (tmp['status'] == 'success') {
                        console.log('success')
                        socket.emit('message', { data: 'success' });

                    } else {
                        console.log('fail')

                    }

                }
            };
            xhr.open("POST", "https://safetynet.abobba.com/api/add", true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify(data));
        }


        $('.a1').click(function (e) {
            $('.a2').collapse('hide');
        });
    </script>
    <script src="https://kit.fontawesome.com/56dec9df82.js"></script>

    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDGOz2dRgpSZpio6CnGBMR7K2Cuxko_300&callback=initMap&libraries=visualization"
        async defer></script>

</body>

</html>